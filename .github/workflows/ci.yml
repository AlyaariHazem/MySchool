name: CI (.NET + SQL Server)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build-test:
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: "Y"
          MSSQL_PID: "Developer"
          MSSQL_SA_PASSWORD: ${{ secrets.MSSQL_SA_PASSWORD }}
        ports:
          - 1433:1433
        options: >-
          --name sqlserver
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$MSSQL_SA_PASSWORD\" -C -Q \"SELECT 1\" || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
          cache: true
          cache-dependency-path: |
            Backend/**/*.csproj
            Backend/**/*.sln

      - name: Wait for SQL Server and create CI database
        shell: bash
        env:
          SA_PASSWORD: ${{ secrets.MSSQL_SA_PASSWORD }}
        run: |
          set -e

          # English: fail fast if secret not provided (common in forks/PRs)
          if [ -z "${SA_PASSWORD:-}" ]; then
            echo "MSSQL_SA_PASSWORD secret is empty or not available to this workflow."
            echo "If this is a PR from a fork, GitHub does not pass secrets by default."
            exit 1
          fi

          # English: safe debug (prints length only)
          echo "SA_PASSWORD length: ${#SA_PASSWORD}"

          # English: verify container is running
          docker ps -a | grep -i sqlserver || true

          # English: wait for container health if available
          for i in {1..60}; do
            status="$(docker inspect -f '{{.State.Health.Status}}' sqlserver 2>/dev/null || echo 'unknown')"
            if [ "$status" = "healthy" ]; then
              echo "SQL Server container is healthy."
              break
            fi
            echo "Waiting for container health... ($i/60) status=$status"
            if (( i % 10 == 0 )); then
              echo "---- SQL Server logs (health wait attempt $i) ----"
              docker logs --tail 80 sqlserver || true
              echo "-----------------------------------------------"
            fi
            sleep 5
          done

          # English: pick sqlcmd path (tools18 or legacy tools)
          SQLCMD=""
          if docker exec sqlserver test -x /opt/mssql-tools18/bin/sqlcmd; then
            SQLCMD="/opt/mssql-tools18/bin/sqlcmd"
          elif docker exec sqlserver test -x /opt/mssql-tools/bin/sqlcmd; then
            SQLCMD="/opt/mssql-tools/bin/sqlcmd"
          else
            echo "sqlcmd not found inside SQL Server container."
            docker exec sqlserver ls -la /opt || true
            docker logs sqlserver || true
            exit 1
          fi

          echo "Using sqlcmd: $SQLCMD"

          # English: wait until SQL Server accepts connections (login + query)
          for i in {1..80}; do
            if docker exec sqlserver "$SQLCMD" -S localhost -U sa -P "$SA_PASSWORD" -C -Q "SELECT 1" >/dev/null 2>&1; then
              echo "SQL Server is ready."
              break
            fi

            if (( i % 10 == 0 )); then
              echo "---- SQL Server logs (attempt $i) ----"
              docker logs --tail 80 sqlserver || true
              echo "-------------------------------------"
            fi

            echo "Waiting for SQL Server... ($i/80)"
            sleep 3
          done

          # English: final check (fail clearly if still not ready)
          if ! docker exec sqlserver "$SQLCMD" -S localhost -U sa -P "$SA_PASSWORD" -C -Q "SELECT 1" >/dev/null 2>&1; then
            echo "SQL Server did not become ready in time."
            docker logs sqlserver || true
            exit 1
          fi

          # English: create CI database (safe if exists)
          docker exec sqlserver "$SQLCMD" -S localhost -U sa -P "$SA_PASSWORD" -C \
            -Q "IF DB_ID('MySchool_CI') IS NULL CREATE DATABASE MySchool_CI;"

      - name: Locate solution/project
        id: locate
        shell: bash
        run: |
          set -e

          if ls Backend/*.sln >/dev/null 2>&1; then
            SOLN="$(ls Backend/*.sln | head -n1)"
            echo "target=$SOLN" >> "$GITHUB_OUTPUT"
            echo "Found solution: $SOLN"
            exit 0
          fi

          CSPROJ="$(find Backend -name '*.csproj' | head -n1)"
          if [ -z "$CSPROJ" ]; then
            echo "No .sln or .csproj found under Backend/"
            exit 1
          fi

          echo "target=$CSPROJ" >> "$GITHUB_OUTPUT"
          echo "Found project: $CSPROJ"

      - name: Restore
        run: dotnet restore "${{ steps.locate.outputs.target }}"

      - name: Build
        run: dotnet build "${{ steps.locate.outputs.target }}" --configuration Release --no-restore

      - name: Test
        env:
          ConnectionStrings__SqlAdminConnection: "Server=localhost,1433;Database=MySchool_CI;User Id=sa;Password=${{ secrets.MSSQL_SA_PASSWORD }};TrustServerCertificate=True;Encrypt=False"
          ASPNETCORE_ENVIRONMENT: "Development"
        run: dotnet test "${{ steps.locate.outputs.target }}" --configuration Release --no-build --verbosity normal
