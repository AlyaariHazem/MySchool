name: CI (.NET + SQL Server)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  build-test:
    # English: secrets are not available on PRs from forks; skip those to avoid false failures
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest

    env:
      SA_PASSWORD: ${{ secrets.MSSQL_SA_PASSWORD }}

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: "Y"
          MSSQL_PID: "Developer"
          MSSQL_SA_PASSWORD: ${{ secrets.MSSQL_SA_PASSWORD }}
        ports:
          - 1433:1433
        options: >-
          --name sqlserver

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
          cache: true
          cache-dependency-path: |
            Backend/**/*.csproj
            Backend/**/*.sln

      - name: Validate SA password
        shell: bash
        run: |
          set -euo pipefail
          # English: fail early with a clear message if secret is missing
          if [ -z "${SA_PASSWORD}" ]; then
            echo "Missing secret MSSQL_SA_PASSWORD (fork PR? secret not set in repo settings?)."
            exit 1
          fi

      - name: Wait for SQL Server and create CI database
        shell: bash
        run: |
          set -euo pipefail

          # English: run sqlcmd either from inside the SQL container (if present) or via the tools image
          run_sqlcmd() {
            local query="$1"

            if docker exec sqlserver test -x /opt/mssql-tools18/bin/sqlcmd; then
              docker exec sqlserver /opt/mssql-tools18/bin/sqlcmd \
                -S localhost -U sa -P "${SA_PASSWORD}" -C -Q "${query}"
              return
            fi

            if docker exec sqlserver test -x /opt/mssql-tools/bin/sqlcmd; then
              docker exec sqlserver /opt/mssql-tools/bin/sqlcmd \
                -S localhost -U sa -P "${SA_PASSWORD}" -C -Q "${query}"
              return
            fi

            # English: fallback to official tools container, sharing the SQL Server container network namespace
            docker run --rm --network container:sqlserver mcr.microsoft.com/mssql-tools18 \
              /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "${SA_PASSWORD}" -C -Q "${query}"
          }

          # English: wait until SQL Server accepts connections
          for i in {1..80}; do
            if run_sqlcmd "SELECT 1" >/dev/null 2>&1; then
              echo "SQL Server is ready."
              break
            fi

            if (( i % 10 == 0 )); then
              echo "---- SQL Server logs (attempt $i) ----"
              docker logs --tail 80 sqlserver || true
              echo "-------------------------------------"
            fi

            echo "Waiting for SQL Server... ($i/80)"
            sleep 3
          done

          # English: create CI database
          run_sqlcmd "IF DB_ID('MySchool_CI') IS NULL CREATE DATABASE MySchool_CI;"

      - name: Locate solution/project
        id: locate
        shell: bash
        run: |
          set -euo pipefail

          if ls Backend/*.sln >/dev/null 2>&1; then
            SOLN="$(ls Backend/*.sln | head -n1)"
            echo "target=$SOLN" >> "$GITHUB_OUTPUT"
            echo "Found solution: $SOLN"
            exit 0
          fi

          CSPROJ="$(find Backend -name '*.csproj' | head -n1)"
          if [ -z "$CSPROJ" ]; then
            echo "No .sln or .csproj found under Backend/"
            exit 1
          fi

          echo "target=$CSPROJ" >> "$GITHUB_OUTPUT"
          echo "Found project: $CSPROJ"

      - name: Restore
        run: dotnet restore "${{ steps.locate.outputs.target }}"

      - name: Build
        run: dotnet build "${{ steps.locate.outputs.target }}" --configuration Release --no-restore

      - name: Test
        env:
          ConnectionStrings__SqlAdminConnection: "Server=localhost,1433;Database=MySchool_CI;User Id=sa;Password=${{ secrets.MSSQL_SA_PASSWORD }};TrustServerCertificate=True;Encrypt=False"
          ASPNETCORE_ENVIRONMENT: "Development"
        run: dotnet test "${{ steps.locate.outputs.target }}" --configuration Release --no-build --verbosity normal
